{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
   rel="stylesheet">

<style>
   :root {
      --bus-theme: red;
      --train-theme: #ccd8f0;
      --glass-bg: rgba(255, 255, 255, 0.95);
      --card-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.05);
   }

   body {
      background-color: #f8fafc;
      font-family: 'Plus Jakarta Sans', sans-serif;
   }

   .search-wrapper {
      background-color: #d1d1d1;
      padding: 60px 0;
      border-radius: 0 0 40px 40px;
      margin-top: -25px;
      margin-bottom: -50px;
   }

   .search-container {
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      padding: 25px;
      border-radius: 24px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
   }

   .form-control,
   .form-select {
      border: 1px solid #e2e8f0;
      padding: 12px 16px;
      border-radius: 12px;
      transition: all 0.3s ease;
   }

   .form-control:focus {
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
      border-color: var(--train-theme);
   }

   .custom-nav-pills {
      background: #eee;
      padding: 6px;
      border-radius: 16px;
      display: inline-flex;
   }

   .custom-nav-pills .nav-link {
      color: #64748b;
      font-weight: 600;
      border-radius: 12px;
      padding: 10px 25px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
   }

   .custom-nav-pills .nav-link.active.bus-tab {
      background: var(--bus-theme);
      color: white !important;
      transition: all ease-in-out .4s;
   }

   .custom-nav-pills .nav-link.active.train-tab {
      background: var(--train-theme);
      color: white;
      transition: all ease-in-out .4s;
   }

   .booking-card {
      background: white;
      border: 1px solid #f1f5f9;
      border-radius: 24px;
      padding: 20px;
      position: relative;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
   }

   .booking-card:hover {
      transform: translateY(-10px) scale(1.02);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
   }

   .card-accent {
      position: absolute;
      top: 0;
      left: 0;
      width: 6px;
      height: 100%;
   }

   .bus-accent {
      background: var(--bus-theme);
   }

   .train-accent {
      background: var(--train-theme);
   }

   .path-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #f1f5f9;
      padding: 15px;
      border-radius: 16px;
      margin: 15px 0;
   }

   .city-name {
      font-weight: 700;
      font-size: 1rem;
      color: #1e293b;
   }

   .time-label {
      font-size: 0.8rem;
      color: #64748b;
      display: block;
   }

   .path-line {
      flex-grow: 1;
      height: 2px;
      background: #cbd5e1;
      margin: 0 15px;
      position: relative;
      border-top: 2px dashed #94a3b8;
   }

   .badge-modern {
      padding: 6px 14px;
      border-radius: 10px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
   }

   .cnf-bg {
      background: #dcfce7;
      color: #166534;
   }

   .can-bg {
      background: #fee2e2;
      color: #991b1b;
   }

   .action-btn {
      border-radius: 12px;
      font-weight: 600;
      padding: 8px 16px;
      transition: 0.3s;
   }
</style>
{% endblock %}

{% block content %}
<div class="search-wrapper text-center">
   <div class="container">
      <h1 class="text-black fw-bold mb-4">Manage Your Journeys</h1>
      <div class="search-container mx-auto col-lg-10">
         <div class="row g-3">
            <div class="col-md-8 text-start">
               <label class="small fw-bold text-muted mb-1 ms-1">Search Booking</label>
               <div class="input-group">
                  <span class="input-group-text bg-white border-end-0 rounded-start-3"><i
                        class="bi bi-search text-primary"></i></span>
                  <input type="text" id="bookingSearch" class="form-control border-start-0"
                     placeholder="PNR, Passenger Name, or Destination..." onkeyup="filterBookings()">
               </div>
            </div>
            <div class="col-md-4 text-start">
               <label class="small fw-bold text-muted mb-1 ms-1">Status</label>
               <select id="statusFilter" class="form-select" onchange="filterBookings()">
                  <option value="all">Everything</option>
                  <option value="CONFIRMED">Confirmed Only</option>
                  <option value="CANCELLED">Cancelled</option>
               </select>
            </div>
         </div>
      </div>
   </div>
</div>

<div class="container" style="margin-top: 80px; margin-bottom: 100px;">
   <div class="text-center mb-5">
      <ul class="nav custom-nav-pills shadow-sm" id="bookingTab" role="tablist">
         <li class="nav-item">
            <button class="nav-link active bus-tab" id="bus-tab" data-bs-toggle="pill" data-bs-target="#bus-bookings">
               <i class="bi bi-bus-front-fill me-2"></i>Bus Trips
            </button>
         </li>
         <li class="nav-item">
            <button class="nav-link train-tab" id="train-tab" data-bs-toggle="pill" data-bs-target="#train-bookings">
               <i class="bi bi-train-front-fill me-2"></i>Train Trips
            </button>
         </li>
      </ul>
   </div>

   <div class="tab-content">
      <div class="tab-pane fade show active" id="bus-bookings">
         <div class="row g-4" id="busContainer">
            {% for booking in bus_bookings %}
            <div class="col-lg-6 booking-item"
               data-search="{{ booking.passenger_name }} {{ booking.bus.source }} {{ booking.bus.destination }} BUS{{ booking.id|add:'1000' }}"
               data-status="{{ booking.booking_status }}">
               <div class="booking-card shadow-sm">
                  <div class="card-accent bus-accent"></div>

                  <div class="d-flex justify-content-between align-items-start mb-2">
                     <div>
                        <h5 class="fw-bold text-dark mb-0 text-capitalize">{{ booking.bus.bus_name }}</h5>
                        <code class="text-muted" style="font-size: 0.8rem;">PNR: BUS{{ booking.id|add:"1000" }}</code>
                     </div>
                     <span
                        class="badge-modern {% if booking.booking_status == 'CONFIRMED' %}cnf-bg{% else %}can-bg{% endif %}">
                        {{ booking.booking_status }}
                     </span>
                  </div>

                  <div class="path-container">
                     <div class="text-start">
                        <span class="time-label">Source</span>
                        <span class="city-name">{{ booking.bus.source }}</span>
                     </div>
                     <div class="path-line">
                        <i
                           class="bi bi-chevron-right position-absolute top-50 start-50 translate-middle text-muted"></i>
                     </div>
                     <div class="text-end">
                        <span class="time-label">Destination</span>
                        <span class="city-name">{{ booking.bus.destination }}</span>
                     </div>
                  </div>

                  <div class="d-flex justify-content-between align-items-center mt-3">
                     <div class="small">
                        <div class="text-muted">Passenger</div>
                        <div class="fw-bold">{{ booking.passenger_name }}</div>
                     </div>
                     <div class="small text-end">
                        <div class="text-muted">Seat</div>
                        <div class="fw-bold">{{ booking.seat_number }}</div>
                     </div>
                     <div class="text-end">
                        <div class="text-muted small">Total Paid</div>
                        <div class="fw-bold text-success fs-5">â‚¹{{ booking.price }}</div>
                     </div>
                  </div>

                  <div class="mt-4 pt-3 border-top d-flex gap-2">
                     <button class="btn action-btn btn-outline-secondary btn-sm flex-grow-1">Track Bus</button>
                     {% if booking.booking_status != 'CANCELLED' %}
                     <button class="btn action-btn btn-danger btn-sm px-4">Cancel Trip</button>
                     {% endif %}
                  </div>
               </div>
            </div>
            {% endfor %}
         </div>
      </div>

      <div class="tab-pane fade" id="train-bookings">
         <div class="row g-4" id="trainContainer">
            {% for booking in train_bookings %}
            <div class="col-lg-6 booking-item"
               data-search="{{ booking.passenger_name }} {{ booking.train.source.city_name }} {{ booking.train.destination.city_name }} {{ booking.pnr_number }}"
               data-status="{{ booking.booking_status }}">
               <div class="booking-card shadow-sm">
                  <div class="card-accent train-accent"></div>

                  <div class="d-flex justify-content-between align-items-start mb-2">
                     <div>
                        <h5 class="fw-bold text-dark mb-0">{{ booking.train.train_name }}</h5>
                        <code class="text-muted">PNR: {{ booking.pnr_number }}</code>
                     </div>
                     <span class="badge-modern cnf-bg">
                        {{ booking.booking_status }}
                     </span>
                  </div>

                  <div class="path-container">
                     <div class="text-start">
                        <span class="time-label">{{ booking.train.departure_time|time:"H:i" }}</span>
                        <span class="city-name">{{ booking.train.source.city_name }}</span>
                     </div>
                     <div class="path-line">
                        <i
                           class="bi bi-train-front position-absolute top-50 start-50 translate-middle text-primary"></i>
                     </div>
                     <div class="text-end">
                        <span class="time-label">{{ booking.train.arrival_time|time:"H:i" }}</span>
                        <span class="city-name">{{ booking.train.destination.city_name }}</span>
                     </div>
                  </div>

                  <div class="row mt-3 text-center g-0 bg-light rounded-3 p-2">
                     <div class="col-4 border-end">
                        <div class="time-label">Class</div>
                        <div class="fw-bold">{{ booking.coach.coach_type }}</div>
                     </div>
                     <div class="col-4 border-end">
                        <div class="time-label">Seat/Berth</div>
                        <div class="fw-bold">{{ booking.seat_number }}</div>
                     </div>
                     <div class="col-4">
                        <div class="time-label">Date</div>
                        <div class="fw-bold">{{ booking.train.travel_date|date:"d M" }}</div>
                     </div>
                  </div>

                  <div class="mt-4 d-flex gap-2">
                     <a href="{% url 'ticket_detail' booking.pnr_number %}"
                        class="btn action-btn btn-primary flex-grow-1 shadow-sm">
                        <i class="bi bi-file-earmark-pdf me-2"></i>Download E-Ticket
                     </a>
                  </div>
               </div>
            </div>
            {% endfor %}
         </div>
      </div>
   </div>
</div>

<script>
   // Previous JS Logic stays the same, just ensured clean UI transition
   function filterBookings() {
      let input = document.getElementById('bookingSearch').value.toLowerCase();
      let status = document.getElementById('statusFilter').value;
      let items = document.getElementsByClassName('booking-item');

      for (let item of items) {
         let searchText = item.getAttribute('data-search').toLowerCase();
         let itemStatus = item.getAttribute('data-status');
         let matchesSearch = searchText.includes(input);
         let matchesStatus = (status === 'all' || itemStatus === status);

         if (matchesSearch && matchesStatus) {
            item.style.display = "block";
            item.style.opacity = "1";
         } else {
            item.style.display = "none";
            item.style.opacity = "0";
         }
      }
   }
</script>
{% endblock %}